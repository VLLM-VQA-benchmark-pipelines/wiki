---
Author:
  - Ширяев Антон
  - Изюмова Анастасия
Implementer:
  - Овчинникова Юлия
  - Ширяев Антон
  - Капустин Евгений
tags: 
start date: 
end date:
---

# Пререквезиты

* **Датасет от Александа** на 10 паспортов, и csv файл к нему
На нем можно тестить модель.
Из него мы узнаем сколько уникальных "doc type question type".
Для этих уникальных значений подбираем промпты.
* Записать видео как поднять контейнер с моделью Qwen2-VL и задать ей картинку и вопрос-промпты и получить от нее ответ.
* **Подготовить Jupyter Notebook** для Colab'a с моделью Qwen2-VL и задать ей картинку и вопрос-промпты и получить от нее ответ.

| image_path  | question        | answer         | doc class | question<br><br>type | answear bbox    |
| ----------- | --------------- | -------------- | --------- | -------------------- | --------------- |
| image/1.jpg | "Текст вопроса" | "Текст ответа" | passport  | "Имя"                | “[10,20,30,40]” |
| image/1.jpg | "Текст вопроса" | "Текст ответа" | passport  | "Фамилия"            | “[10,20,30,40]” |
| image/3.jpg | "Текст вопроса" | “Текст ответа” | document  | "Сумма"              | “[10,20,30,40]" |


| doc type question type | optimal prompt       | promt model | Answer             |
| ---------------------- | -------------------- | ----------- | ------------------ |
| Паспорт Имя            | "Текст опт. промпта" | GPT4o       | "Правильный ответ" |
| Паспорт Имя            | "Текст опт. промпта" | GPT4o       | "Правильный ответ" |
| Паспорт Имя            | "Текст опт. промпта" | Qwen2-VL-72 | "Правильный ответ" |

# Описание

напиши промпт для модели Qwen2-VL-2B чтобы он отдал фамилию на паспорте

Промпт1 для квен
Промпт2 для квен

Карибажанов
Фамилий 1- штук

CER1 - промпт плохой
CER2 - промпт хороший

Подобрать максимальный хороший промт под каждую модель на определенных данных.

1. Идем к модели которая советует нам пропты - Gpt4o, DeepSeek, Qwen2-Vl-72B, .....
2. Получаем от нее промпт


В качестве моделей советующих промпты выбрать любые 5 самых крутых.

1. Ручной перебор
2. Использование автоматизированных инструментов для получения лучшего промпта для конкретной модели на конкретных данных.


### Итоговые csv
"Датасет-Фреймворк-Модель-Промпты"

"<название_модели_дающей_ответ>_<название_модели_дающей_промпты>.csv"
"Qwen2-VL-2B_sep_Qwen2-VL-72B.csv"
"Qwen2-VL-2B_sep_GPT4o.csv" 
"Qwen2-VL-2B__sep_DeepSeek.csv"
"Qwen2-VL-2B__sep_OptimalPromts.csv"

15 + 10 + 

"Qwen2-VL-2B_sep_GPT4o.csv" 

| doc type question type | optimal prompt       | cer |
| ---------------------- | -------------------- | --- |
| Паспорт Имя            | "Текст опт. промпта" | 0.1 |
| Паспорт Номер паспорта | "Текст опт. промпта" | 0.2 |
| СНИЛС                  | "Текст опт. промпта" | 0.2 |
"Qwen2-VL-2B_sep_Qwen2-VL-72B.csv"

| doc type question type | optimal prompt       | cer |
| ---------------------- | -------------------- | --- |
| Паспорт Имя            | "Текст опт. промпта" | 0.1 |
| Паспорт Номер папорта  |                      | 0.2 |
| СНИЛС                  |                      | 0.2 |

Qwen2-VL-2B__sep_OptimalPromts.csv"

| doc type question type | optimal prompt                       | cer |
| ---------------------- | ------------------------------------ | --- |
| Паспорт Имя            | "Текст опт. промпта от GPT4o"        | 0.1 |
| Паспорт Номер папорта  | "Текст опт. промпта от DeepSeek"     | 0.2 |
| СНИЛС                  | "Текст опт. промпта от Qwen2-VL-72B" | 0.2 |
15 вопросов * 5 = 75 промптов.



### Стратегии подбора промптов
Обсудили стратегии с Анастасией полуавтоматизированные способы подборки пропта:
1. https://www.promptingguide.ai/techniques/fewshot
2. https://lmarena.ai/
3. https://docs.confident-ai.com/docs/getting-started
4. https://textgrad.com/
5. https://medium.com/aiguys/textgrad-controlling-llm-behavior-via-text-2a82e2073d10

Сообщение из тг [ссылка](https://t.me/white_tensor/500)
Если продолжаете заниматься ручным тюнингом промптов, то есть не плохая схема:

1. Нужен тестовый датасет (или отсматривать вручную, или размеченный)

2. Заходим на https://lmarena.ai/
— Генерировать будем через "Arena (battle)"
— Там есть и o1 новые, и в целом нет лимитов на генерацию

3. Формируем промпт для улучшения промпта:
— Берём текущие промпты и их скоры
— Рассказываем саму задачу и какие показатели ожидаем (иногда мы можем специально делать не общую точность максимальной, а recall, или только точные негативы)
— Просим проанализировать промпты которые уже есть и их скоры
— И просим написать новый промпт с учётом всего

4. Проверка сгенерированных промптов
— У нас будет 2 сгенерированных новых промпта от 2 рандомных моделей (на самом деле обычно там попадаются +- топовые модели, в том числе и новые как o1)
— Берём их и проверяем на нашем тестовом датасете
— Если какой-то из промптов понравился, то оставляем его себе и добавляем\заменяем в список промптов с метриками в улучшающий промпт
— Повторять можно бесконечно, со временем промпт по настоящему улучшается

Подобная техника в основном нужна, когда уже есть хорошие промпты и не особо получается их уже улучшить.

Из интересного:
▫️ Далеко не всегда лучшие промпты придумывает лучшая модель
▫️ Часто лучший промпт придумывает модель из того же семейства (та же самая, или с большим кол-вом параметров). Например, для gemma2-9b-it это gemma2-27b-it, для qwen2.5-32b-instruct это оказалась API версия qwen-plus

Так же напоминаю про textgrad (https://github.com/zou-group/textgradhttps://github.com/zou-group/textgrad), который тоже можно использовать для автоматического улучшения промптов.



# Результаты

1. Проанализированы материалы по написанию промптов --> [Prompt Engineering](../../../cards/Prompt%20Engineering.md)
2. От идеи работать на Google Colab отказались, так как наш пайплайн работает через Docker-контейнер и с GPU, поэтому запустить его на этой платформе корректную работу нет возможности. В процессе настройки:
	1. была рассмотрена библиотека udocker
	2. залит Docker образ модели Qwen2-VL-2B на [DockerHub](https://hub.docker.com/r/medphisiker/simple_bench/tags)
3. Доработан в части метрик пайплайн бенчмарка, исправлены баги
4. Добавлен скрип по обработке путей в файлах annotation.csv --> rename_paths_annotation.py

Доделать:
1. Доработать пайплайн для прогона промптов
2. Сгенерировать промты от разных больших LLM
3. Изучить метрики CER
4. Собрать csv файлы с оптимальными промтами

